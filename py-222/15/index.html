<!doctype html>
<html lang="uk">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Курс Python - WebTeach</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Ruda:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,200;0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600&family=Ruda:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/src/python-course/css/style.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light ">
      <div class="container-xl">
      <a class="navbar-brand logo" href="../"><span>Web</span>Teach</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav mr-auto mt-2 mt-lg-0" >
          <a class="nav-item nav-link" href="../index.html#course" title="Перейти до курсу Python">Курс<span class="sr-only">(current)</span></a>
          <a class="nav-item nav-link conf-button active" title="Перейти до онлайн-уроку" href="https://meet.jit.si/teach-py-222" target="_blank">
            <svg class="bi bi-camera-video-fill" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.667 3h6.666C10.253 3 11 3.746 11 4.667v6.666c0 .92-.746 1.667-1.667 1.667H2.667C1.747 13 1 12.254 1 11.333V4.667C1 3.747 1.746 3 2.667 3z"/>
              <path d="M7.404 8.697l6.363 3.692c.54.313 1.233-.066 1.233-.697V4.308c0-.63-.693-1.01-1.233-.696L7.404 7.304a.802.802 0 0 0 0 1.393z"/>
            </svg>
            Онлайн-урок</a>
          <a class="nav-item nav-link" href="https://repl.it/languages/python3" title="Відкрити онлайн-редактор коду" target="_blank">Редактор</a>
          <!-- <a class="nav-item nav-link" href="../journal.html" data-toggle="tooltip" data-placement="bottom">Журнал</a> -->
          
          
        </div>
        <div class="nav-phone my-2 my-lg-0">
          <a href="tel:+380956774158" class="nav-item nav-link">+380956774158</a>
        </div>
        </div>
     </div> 
     </nav>
     <!-- nav end -->
     <div class="header-baner container-fluid d-flex justify-content-xl-space-between pb-0 pt-4">       
      <h1 >Тема 15. Мікрофреймворк Flask. Створення сайту за допомогою Python.</h1>
    </div>
   <div class="video-arrow rounded-circle" onclick="slowScroll('#lesson')" id="video-arrow" style="width: 50px;">
     <a href="#lesson" >
      <svg width="2.5em" height="2.5em" viewBox="0 0 16 16" class="bi bi-arrow-down-circle-fill" fill="rgba(255,255,255, .3)" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/>
      </svg>
     </a>
   </div>
      <div id="videomeet">
        <iframe allow="camera; microphone; fullscreen; display-capture" src="https://meet.jit.si/teach-py-222" style="height: 100%; width: 100%; border: 0px;" ></iframe>         
      </div>

      <div class="container-xl mt-5" id="lesson" style='min-height: 100vh;'>

        <div class="accordion" id="accordionExample" style=" margin: 50px auto">
          <div class="card">
            <div class="card-header d-flex justify-content-xl-space-between" id="headingOne">
              <h5 class="mb-0">
                <button class="btn btn-link" type="button"  data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                  <h5>Інформація для роботи ↓</h5> 
                </button>
              </h5>             
            </div>
            <div id="collapseOne" class="collapse " aria-labelledby="headingOne" data-parent="#accordionExample">
              <div class="card-body">
                <div class='theory'>
                  <h3>Команди для командного рядка</h3><br>
                 <div class='answer'>
                 <ul>
                 <li><code>python -m venv venv</code><b> або </b> <code>python3 -m venv venv</code>- <b>створити віртуальне середовище.</b></li><br>
                 <li><code>venv\Scripts\activate</code> - <b>активувати віртуальне середовище.</b></li><br>
                 <li> <code>pip install Flask </code> <b> або </b> <code>pip3 install Flask </code>- <b>встановити модуль Flask.</b></li><br>
                 <li> <code>pip install flask-login</code> <b> або </b> <code>pip3 install flask-login </code>- <b>встановити модуль FlaskLogin.</b></li><br>
                
        
                 </div>
                 <div class="theory">
                   <h3>Підключення до бібліотек</h3>
                  </div>
                   <div class="answer">
                    <pre>
                      <code>
from flask import Flask, render_template, url_for,  request, flash, session, redirect, abort
from werkzeug.security import generate_password_hash, check_password_hash
import pymysql
from pymysql.cursors import DictCursor
from classes import *

from flask_login import LoginManager, login_required, login_user
from UserLogin import UserLogin</code>
                    </pre>
                   </div>
                 
                 <div class='theory'>
                  <h3>Посилання</h3><br>
                 <div class='answer'>
                 <ul>
                 <li> <a href="https://bootstrap-4.ru/docs/4.5/" target="_blank"><b>bootstrap-4.ru</b>/</a>  - <b>CSS-фреймворк Bootstrap.</b></li><br>
                 <li> <a href="https://fancyapps.com/fancybox/3/" target="_blank"><b>fancyapps.com/fancybox/3/</b>/</a>  - <b>плагін для відкриття відео з ютубу</b></li><br>
                 <li> <a href="https://hackerthemes.com/bootstrap-cheatsheet/" target="_blank"><b>hackerthemes.com/bootstrap-cheatsheet/</b>/</a>  - <b>Наочна таблиця з класами Bootstrap4</b></li><br>
                 <li> <a href="https://id.heroku.com/login" target="_blank"><b>heroku.com</b>/</a>  - <b>сервіс для безкоштовного деплою та розміщення веб-додатків</b></li><br>

                 </div>
                 <div class='theory'>
                  <h3>Публікація на сервер за допомогою <a href="https://id.heroku.com/login" target="_blank">heroku.com</a></h3><br>
                 <div class='answer'>
                 <ul>
                 <li>1. <code>heroku login</code> авторизація в heroku (в командному рядку)</li>
                 <li>2. <code>pip install gunicorn</code></li>
                 <li>3. <code>pip freeze> requirements.txt</code></li>
                 <li>4. Створити файл <b>Procfile</b> з командою: <code>web: gunicorn app:app</code></li>
                 <li>5.  У venv  створити файл <b>.gitignore</b></li>
                 <li>6. <code>git add .</code> фіксація всіх файлів</li>
                 <li>7. <code>git commit -am "add all files"</code> збереження всіх змін</li>
                 <li>8. <code>git push heroku master </code> - надсилання в heroku</li>

                 </div>
              </div> 
            </div> 
        </div> 
      </div>  
            </div> 
            <div class="card">
              <div class="card-header d-flex justify-content-xl-space-between" id="heading2">
                <h5 class="mb-0">
                  <button class="btn btn-link" type="button"  data-toggle="collapse" data-target="#collapse2" aria-expanded="false" aria-controls="collapse2">
                    <h5><b>Flask-Login</b> ↓</h5> 
                  </button>
                </h5>             
              </div>
              <div id="collapse2" class="collapse " aria-labelledby="heading2" data-parent="#accordionExample">
                <div class="card-body">
                  <h3>Порядок дій для реалізації логіну за допомогою Flask-Login</h3>
                      <p>Підключення необхідних імпортів <br><code>from flask_login import LoginManager, login_required, login_user,logout_user, current_user</code></p>
                      <p>Створення об'єкту класу <b>LoginManager</b><br>
                        <code>login_manager = LoginManager(app)</code>
                      </p>
                      <p>Створення класу представлення користувача - <b>UserLogin</b><br>
<div class="answer"><code>
<pre>
class UserLogin:
  def fromDB(self, userID, cursor): <span style="color: rgb(0, 107, 0); font-style: italic;"># додаткова функція  для отримання інформації про користувача з бази даних </span>
     self.userID = userID
     self.cursor = cursor
     self.cursor.execute('SELECT * FROM Users WHERE id=%s',self.userID)
     self.__user = self.cursor.fetchone()
     return self

  def create(self, user): <span style="color: rgb(0, 107, 0); font-style: italic;"># функція створення користувача </span>
     self.__user = user
     return self
  
  def is_authenticated(self): <span style="color: rgb(0, 107, 0); font-style: italic;"># функція перевірки авторизації користувача </span>
     return True
  
  def is_active(self): <span style="color: rgb(0, 107, 0); font-style: italic;"># функція перевірки активності користувача</span>
     return True
  
  def is_anonymous(self):<span style="color: rgb(0, 107, 0); font-style: italic;"># функція перевірки неавторизованих користувачів </span>
     return False
  
  def get_id(self):<span style="color: rgb(0, 107, 0); font-style: italic;"># функція, що повертає унікальний ідентифікатор користувача (у вигляді рядка)</span>
     return str(self.__user['id'])
     
</pre>
</code>
</div>
</p>
<p>
  Далі, в обробнику процесу логіну користувача створюється об'єкт класу UserLogin і передається спеціальній функції <code>login_user</code>, яка визначена в модулі Flask-Login: <br>
  <div class="answer"><code>
<pre>
@app.route('/login', methods=["POST", "GET"])
def login():
  if request.method == "POST":
      ...#отримання даних про користувача
        userLogin = UserLogin().create(user_db)
        <b>login_user(userLogin)</b> <span style="color: rgb(0, 107, 0); font-style: italic;"># функція вносить інформацію про залогіненого користувача в сесії браузера</span>
      ...#вивід відповіді (перенаправлення, флеш повідомлення)
</pre>
</code>
</div>
</p>
                
                <p>
                  Ця функція заносить в сесію інформацію про залогіненого користувача, використовуючи певні методи класу. Після цього сесійна інформація буде присутня у всіх запитах до сервера. Для її обробки у Flask-Login визначено спеціальний декоратор: <br>
  <div class="answer"><code>
<pre>
@login_manager.user_loader
def load_user(user_id):
    print("load_user")
    return UserLogin().fromDB(user_id, cursor)
</pre>
</code>
Причому функції load_user цього декоратора буде переданий ідентифікатор користувача, який присутній в сесії запиту. Фактично, це буде user_id, який повертається методом get_id класу UserLogin.</div> 
</p>
<p>
  Коли весь цей механізм реалізований, ми дуже легко можемо обмежувати доступ до різних сторінок сайту. Наприклад, зробимо так, щоб сеанси на фільм можна було переглядати тільки авторизованим користувачам. Для цього перед функцією представлення додається декоратор <b>@login_required</b>: <br>
<code>
<pre>
@app.route('/films/<filmID>/session/<sessionID>')
@login_required
def sessionView(filmID, sessionID):
      ...    
</pre>
</code>
</p>     
<p>
  Функція <b>logout_user()</b> очищає сесію і робить користувача неавторизованим. Потім, формується миттєве повідомлення і перенаправлення на форму авторизації.<br>
  <div class="answer"><code>
<pre>
@app.route('/logout')
def logout():
    <b>logout_user()</b>
    flash('Ви вийшли з профілю', category='alert-warning')
    return redirect(url_for('login'))
</pre>
</code>
</div>
</p>
<p>
  Припустимо, що ми не авторизовані і намагаємося відвідати закриту сторінку. У цьому випадку сервер поверне код 401 - сторінка недоступна. Але це не найкраща поведінка сайту. Більш дружній інтерфейс повинен перенаправляти користувача, наприклад, на форму авторизації. Це робиться наступними рядками: <br>
  <div class="answer"><code>
<pre>
login_manager.login_view = 'login'
login_manager.login_message = 'Авторизуйтесь, щоб переглядати цю сторінку'
login_manager.login_category = 'alert-warning'
</pre>
</code>
<b>login_view</b> перенаправляє на сторінку логіну, а <b>login_message</b> та <b>login_category</b> задають параметри флеш-повідомлення для таких ситуацій.
</div>
</p>
<p>
  Нарешті, останній важливий штрих. Якщо авторизований користувач перейде за адресою /login, то він побачить форму авторизації, що якось неприродно, адже він же вже увійшов на сайт! Тому в обробнику login на самому початку можна зробити таку перевірку:
  <div class="answer"><code>
<pre>
  if current_user.is_authenticated:
    return redirect(url_for('index'))
</pre>
</code>
</div>
</p>
          </div> 
        </div>  
             
          <div class="card">
            <div class="card-header d-flex justify-content-xl-space-between align-items-center" id="heading11">
              <h5 class="mb-0">
                <h5>Код. Остання версія: </h5> 
                <a href="https://drive.google.com/drive/folders/1DNUnNy1E8ImoHo7R84ZvitihWxE837vE?usp=sharing" target="_blank" class=" btn-warning btn-lg ml-3" role="button" aria-pressed="true"><b>Завантажити файли</b></a>
              </h5>
              
            </div>
               
          </div> 
          <div class="card alert-primary">
            <div class="card-header d-flex justify-content-xl-space-between" id="heading3">
              <h5 class="mb-0">
                <button class="btn btn-link" type="button"  data-toggle="collapse" data-target="#collapse3" aria-expanded="false" aria-controls="collapse3">
                  <h5>Кодимо разом - ВІДЕОЗАПИСИ ЗАНЯТЬ ↓</h5> 
                </button>
              </h5>             
            </div>
           
            <div id="collapse3" class="collapse" role="tabpanel" aria-labelledby="heading3">
              <div class="card-body">
                  <h4 class="alert-heading">Кодимо разом</h4>
                  <p>Запис заняття:</p>
                  <iframe width="100%" style="min-height: 310px; max-width: 500px;"  height="100%" src="https://www.youtube.com/embed/WXNZL9wwLBU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                  <iframe width="100%" style="max-width: 500px;" height="310" src="https://www.youtube.com/embed/-alo8N3jFpg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                   <iframe width="100%" style="max-width: 500px;" height="310" src="https://www.youtube.com/embed/SC0j_O0qOBE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                   <iframe width="100%" style="max-width: 500px;" height="310" src="https://www.youtube.com/embed/a6Io7oeTx4M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                   <iframe width="100%" style="max-width: 500px;" height="310" src="https://www.youtube.com/embed/mEuSOGVUG-8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


          </div>
          </div>
        </div>   
  </div>
</div>

        <!-- accordion  end -->
        <div class="sendform mt-4">
          <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeQIkQW3Dr4X5tnQjH_V_n1iK-twRTprv4WLIc1g_ZG7P3HBw/viewform?embedded=true" width="100%" height="680" frameborder="0" marginheight="0" marginwidth="0" scrolling="auto" seamless>Завантаження…</iframe>
        </div>
      </div>
    </div>
  </div>
  <!-- container end -->
</div>
<!-- main end -->
      <footer class="footer  mt-auto py-3">
        <div class="container">
          <span class="text-muted">©   WebTeach 2020. Всі права застережено</span>
        </div>
      </footer>
      <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
			  src="https://code.jquery.com/jquery-3.5.1.min.js"
			  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			  crossorigin="anonymous"></script>
    <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script type="text/javascript"> 
      function slowScroll(id) { 
          var offset = 0;
          $('html, body').animate({ 
               scrollTop: $(id).offset().top - offset 
          }, 1000);
          
          return false; 
      } 
      
      
 </script>  
    


  </body>
</html>